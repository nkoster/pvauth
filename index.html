<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <title>FHIR Station</title>
</head>
<body>
<div></div>
<script>
const loginURI = encodeURI('https://oic.docker.portavita.net:9090/authorize?client_id=local-react-app&redirect_uri=http://localhost:8080&nonce=asdf&response_type=id_token+token&scope=openid')
const logoutURI = encodeURI('https://docker.portavita.net:8001/uitgelogd.html')
const div = document.querySelector('div')
const qs = decodeURI(window.location.href.split('#')[1])
const qs2obj = qs => qs
  .split('&')
  .map(s => s.split('='))
  .reduce((o, [k, v]) => (o[k] = v ? v : true, o), {})
const data = qs2obj(qs)
if (!data.access_token) {
  window.location.replace(loginURI)
}
const logout = _ => {
  window.location.replace(logoutURI)
}
div.innerHTML = `<button onclick="logout()"><span>logout</span></button><br>${
  data.access_token ? data.access_token : 'loading...'
}`
window.history.replaceState('FHIR Station', 'FHIR Station', '/')
const span = document.querySelector('span')
let expiresIn = parseInt(data.expires_in)
if (!isNaN(expiresIn)) {
  const logoutTime = Date.now() + expiresIn * 1000 
  setInterval(_ => {
    if (logoutTime - Date.now() < 1) logout()
    const minutesLeft = Math.round((logoutTime - Date.now()) / 1000 / 60)
    span.innerText = `logout (auto in ${minutesLeft} min)`
  }, 1000)
  console.log(data)
}
</script>
</body>
</html>
